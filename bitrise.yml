---
format_version: '8'
default_step_lib_source: 'https://github.com/bitrise-io/bitrise-steplib.git'
project_type: react-native

#Pipelines are listed below
pipelines:
  #Creates MetaMask-QA apps and stores apk/ipa in Bitrise
  create_qa_builds_pipeline:
    stages:
      - create_build_qa: {}
  #Builds MetaMask, MetaMask-QA apps and stores apk/ipa in Bitrise
  build_all_targets_pipeline:
    stages:
      - create_build_all_targets: {}
  #Releases MetaMask apps and stores apk/ipa into Play(Internal Testing)/App(TestFlight) Store
  release_builds_to_store_pipeline:
    stages:
      - create_build_release: {}
      - deploy_build_release: {}
      - create_build_qa: {} #Generate QA builds for E2E app upgrade tests
  #Releases MetaMask apps and stores ipa into App(TestFlight) Store
  release_ios_to_store_pipeline:
    stages:
      - create_ios_release: {}
      - deploy_ios_release: {}
  #Releases MetaMask apps and stores apk Play(Internal Testing) Store
  release_android_to_store_pipeline:
    stages:
      - create_android_release: {}
      - deploy_android_release: {}
  #Run E2E test suite for iOS only
  run_e2e_ios_pipeline:
    stages:
      - build_e2e_ios_stage: {}
      - run_e2e_ios_stage: {}
      - notify: {}
  #Run E2E test suite for iOS Flask only
  run_e2e_flask_pipeline:
    stages:
      - build_smoke_e2e_ios_android_stage: {}
      - run_flask_tests_stage: {}
  #Run E2E test suite for Android only
  run_e2e_android_pipeline:
    stages:
      - build_e2e_android_stage: {} #builds android detox E2E
      - run_e2e_android_stage: {} #runs android detox test E2E
      - notify: {}
  #PR_e2e_verfication (build ios & android), run iOS (smoke), emulator Android
  release_e2e_pipeline:
    stages:
      - build_e2e_ios_android_stage: {}
      - run_release_e2e_ios_android_stage: {}
      - report_results_stage: {}
      - notify: {}
  #PR_e2e_verfication (build ios & android), run iOS (smoke), emulator Android
  pr_smoke_e2e_pipeline:
    stages:
      - build_smoke_e2e_ios_android_stage: {}
      - run_smoke_e2e_ios_android_stage: {}
      - notify: {}
  
  #PR_e2e_verfication for Flask tests
  pr_flask_e2e_pipeline:
    stages:
      - build_smoke_e2e_ios_android_stage: {}
      - run_flask_tests_stage: {}
      - notify: {}

  #PR_e2e_verfication (build ios & android), run iOS (regression), emulator Android
  pr_regression_e2e_pipeline:
    stages:
      - build_regression_e2e_ios_android_stage: {}
      - run_regression_e2e_ios_android_stage: {}
      - notify: {}
  #App launch times pipeline. Runs on browserstack
  app_launch_times_and_expo_pipeline:
    stages:
      - create_build_qa_and_expo: {}
      - app_launch_times_test_stage: {}
  #App Upgrade pipeline. Runs on browserstack
  app_upgrade_pipeline:
    stages:
      - create_build_qa_android: {}
      - app_upgrade_test_stage: {}
  multichain_permissions_e2e_pipeline:
    stages:
      - build_multichain_permissions_e2e_ios_android_stage: {}
      - run_multichain_permissions_e2e_ios_android_stage: {}
  # Pipeline for Flask
  create_flask_release_builds_pipeline:
    stages:
      - create_build_flask_release: {}
      - notify: {}
  release_flask_builds_to_store_pipeline:
    stages:
      - create_build_flask_release: {}
      - deploy_flask_build_release: {}
      - release_notify: {}
#Stages reference workflows. Those workflows cannot but utility "_this-is-a-utility"
stages:
  create_build_all_targets:
    workflows:
      - build_android_release: {}
      - build_ios_release: {}
      - build_android_qa: {}
      - build_ios_qa: {}
  create_build_release:
    workflows:
      - build_android_release: {}
      - build_ios_release: {}
  deploy_build_release:
    workflows:
      - deploy_android_to_store: {}
      - deploy_ios_to_store: {}
  create_ios_release:
    workflows:
      - build_ios_release: {}
  deploy_ios_release:
    workflows:
      - deploy_ios_to_store: {}
  create_android_release:
    workflows:
      - build_android_release: {}
  deploy_android_release:
    workflows:
      - deploy_android_to_store: {}
  create_build_qa_and_expo:
    workflows:
      - build_android_devbuild: {}
      - build_android_qa: {}
      - build_ios_devbuild: {}
      - build_ios_qa: {}
  create_build_qa:
    workflows:
      - build_android_qa: {}
      - build_ios_qa: {}
  create_build_qa_android:
    workflows:
      - build_android_qa: {}
  create_build_qa_ios:
    workflows:
      - build_ios_qa: {}
  build_e2e_ios_stage:
    workflows:
      - ios_e2e_build: {}
  build_e2e_ios_flask_stage:
    workflows:
      - ios_e2e_build_flask: {}
  run_e2e_ios_stage:
    workflows:
      - ios_e2e_test: {}
  run_e2e_ios_flask_stage:
    workflows:
      - ios_e2e_test_flask: {}
  build_smoke_e2e_ios_android_stage:
    abort_on_fail: true
    workflows:
      - ios_e2e_build: {}
      - android_e2e_build: {}
  build_multichain_permissions_e2e_ios_android_stage:
    abort_on_fail: true
    workflows:
      - build_ios_multichain_permissions_e2e: {}
      - build_android_multichain_permissions_e2e: {}
  run_multichain_permissions_e2e_ios_android_stage:
    workflows:
      - run_tag_multichain_permissions_ios: {}
      - run_tag_multichain_permissions_android: {}
  run_smoke_e2e_ios_android_stage:
    workflows:
      - run_ios_api_specs: {}
      - run_tag_smoke_accounts_ios: {}
      - run_tag_smoke_accounts_android: {}
      # - run_tag_smoke_identity_ios: {}
      # - run_tag_smoke_identity_android: {}
      # - run_tag_smoke_assets_ios: {}
      - run_tag_smoke_assets_android: {}
      - run_tag_smoke_confirmations_ios: {}
      - run_tag_smoke_confirmations_android: {}
      - run_tag_smoke_ramps_android: {}
      # run_tag_smoke_ramps_ios: {}
      - run_tag_smoke_confirmations_redesigned_ios: {}
      - run_tag_smoke_swaps_ios: {}
      - run_tag_smoke_swaps_android: {}
      # run_tag_smoke_stake_ios: {}
      # run_tag_smoke_stake_android: {}
      - run_tag_smoke_core_ios: {}
      - run_tag_smoke_core_android: {}
      - run_tag_multichain_permissions_ios: {}
      - run_tag_multichain_permissions_android: {}
  build_regression_e2e_ios_android_stage:
    workflows:
      - ios_run_regression_tests: {}
      - android_run_regression_tests: {}
  run_regression_e2e_ios_android_stage:
    workflows:
      - ios_run_regression_tests: {}
      - android_run_regression_tests: {}
  run_flask_tests_stage:
    workflows:
      - run_tag_flask_tests_ios: {}
      - run_tag_flask_tests_android: {}
  run_tag_upgrade_android:
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: elite-xl
    envs:
      - PRODUCTION_APP_URL: 'bs://6b59d556df4a5a0448ff161cbfcab16d92607b72' # Last production's QA build
      - PRODUCTION_BUILD_NAME: 7.38.0
      - PRODUCTION_BUILD_NUMBER: 1528
      - CUCUMBER_TAG_EXPRESSION: '@upgrade and @androidApp'
      - PRODUCTION_BUILD_STRING: 'MetaMask-QA v$PRODUCTION_BUILD_NAME ($PRODUCTION_BUILD_NUMBER)'
      - NEW_BUILD_STRING: 'MetaMask-QA v$VERSION_NAME ($VERSION_NUMBER)'
      - TEST_TYPE: 'upgrade'
    after_run:
      - wdio_android_e2e_test
  build_ios_multichain_permissions_e2e:
    after_run:
      - ios_e2e_build
      # - android_e2e_build
  build_android_multichain_permissions_e2e:
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: elite-xl
    after_run:
      - android_e2e_build
  run_android_app_launch_times_appium_test:
    envs:
      - TEST_TYPE: 'performance'
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: elite-xl
    after_run:
      - wdio_android_e2e_test

  ### Report automated test results to TestRail
  run_testrail_update_automated_test_results:
    before_run:
      - code_setup
    steps:
      - script@1:
          title: 'Add Automated Test Results to TestRail'
          inputs:
            - content: |-
                #!/usr/bin/env bash
                echo 'REPORT AUTOMATED TEST RESULTS TO TESTRAIL'
                node ./scripts/testrail/testrail.api.js

  run_ios_app_launch_times_appium_test:
    envs:
      - TEST_TYPE: 'performance'
    meta:
      bitrise.io:
        stack: osx-xcode-15.0.x
        machine_type_id: g2.mac.large
    after_run:
      - wdio_ios_e2e_test

  ### Separating workflows so they run concurrently during smoke runs
  run_tag_smoke_accounts_ios:
    envs:
      - TEST_SUITE_FOLDER: './e2e/specs/accounts/*'
      - TEST_SUITE_TAG: '.*SmokeAccounts.*'
    after_run:
      - ios_e2e_test
  run_tag_smoke_accounts_android:
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: elite-xl
    envs:
      - TEST_SUITE_FOLDER: './e2e/specs/accounts/*'
      - TEST_SUITE_TAG: '.*SmokeAccounts.*'
    after_run:
      - android_e2e_test
  run_tag_smoke_identity_ios:
    envs:
      - TEST_SUITE_FOLDER: './e2e/specs/identity/*'
      - TEST_SUITE_TAG: '.*SmokeIdentity.*'
    after_run:
      - ios_e2e_test
  run_tag_smoke_identity_android:
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: elite-xl
    envs:
      - TEST_SUITE_FOLDER: './e2e/specs/identity/*'
      - TEST_SUITE_TAG: '.*SmokeIdentity.*'
    after_run:
      - android_e2e_test
  run_tag_smoke_assets_ios:
    envs:
      - TEST_SUITE_FOLDER: './e2e/specs/assets/*'
      - TEST_SUITE_TAG: '.*SmokeAssets.*'
    after_run:
      - ios_e2e_test
  run_tag_smoke_assets_android:
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: elite-xl
    envs:
      - TEST_SUITE_FOLDER: './e2e/specs/assets/*'
      - TEST_SUITE_TAG: '.*SmokeAssets.*'
    after_run:
      - android_e2e_test
  run_tag_smoke_confirmations_ios:
    envs:
      - TEST_SUITE_FOLDER: './e2e/specs/confirmations/*'
      - TEST_SUITE_TAG: '.*SmokeConfirmations.*'
    after_run:
      - ios_e2e_test
  run_tag_smoke_confirmations_android:
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: elite-xl
    envs:
      - TEST_SUITE_FOLDER: './e2e/specs/confirmations/*'
      - TEST_SUITE_TAG: '.*SmokeConfirmations.*'
    after_run:
      - android_e2e_test
  run_tag_smoke_confirmations_redesigned_ios:
    envs:
      - TEST_SUITE_FOLDER: './e2e/specs/confirmations-redesigned/*'
      - TEST_SUITE_TAG: '.*SmokeConfirmationsRedesigned.*'
    after_run:
      - ios_e2e_test
  run_tag_smoke_swaps_ios:
    envs:
      - TEST_SUITE_FOLDER: './e2e/specs/swaps/*'
      - TEST_SUITE_TAG: '.*SmokeSwaps.*'
    after_run:
      - ios_e2e_test
  run_tag_smoke_swaps_android:
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: elite-xl
    envs:
      - TEST_SUITE_FOLDER: './e2e/specs/swaps/*'
      - TEST_SUITE_TAG: '.*SmokeSwaps.*'
    after_run:
      - android_e2e_test
  run_tag_smoke_stake_ios:
    envs:
      - TEST_SUITE_FOLDER: './e2e/specs/stake/*'
      - TEST_SUITE_TAG: '.*SmokeStake.*'
    after_run:
      - ios_e2e_test
  run_tag_smoke_stake_android:
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: elite-xl
    envs:
      - TEST_SUITE_FOLDER: './e2e/specs/stake/*'
      - TEST_SUITE_TAG: '.*SmokeStake.*'
    after_run:
      - android_e2e_test
  run_ios_api_specs:
    after_run:
      - ios_api_specs
  run_tag_smoke_core_ios:
    envs:
      - TEST_SUITE_FOLDER: './e2e/spec/*/**/*'
      - TEST_SUITE_TAG: '.*SmokeCore.*'
    after_run:
      - ios_e2e_test
  run_tag_smoke_core_android:
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: elite-xl
    envs:
      - TEST_SUITE_FOLDER: './e2e/spec/*/**/*'
      - TEST_SUITE_TAG: '.*SmokeCore.*'
    after_run:
      - android_e2e_test
  run_tag_multichain_permissions_ios:
    envs:
      - TEST_SUITE_FOLDER: './e2e/specs/multichain/*'
      - TEST_SUITE_TAG: '.*SmokeMultiChainPermissions.*'
    after_run:
      - ios_e2e_test
  run_tag_multichain_permissions_android:
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: elite-xl
    envs:
      - TEST_SUITE_FOLDER: './e2e/specs/multichain/*'
      - TEST_SUITE_TAG: '.*SmokeMultiChainPermissions.*'
    after_run:
      - android_e2e_test
  run_tag_smoke_ramps_ios:
    envs:
      - TEST_SUITE_FOLDER: './e2e/specs/ramps/*'
      - TEST_SUITE_TAG: '.*SmokeRamps.*'
    after_run:
      - ios_e2e_test
  run_tag_smoke_ramps_android:
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: elite-xl
    envs:
      - TEST_SUITE_FOLDER: './e2e/specs/ramps/*'
      - TEST_SUITE_TAG: '.*SmokeRamps.*'
    after_run:
      - android_e2e_test
  run_tag_flask_tests_ios:
    envs:
      - TEST_SUITE_FOLDER: './e2e/specs/flask/*'
      - TEST_SUITE_TAG: '.*Flask.*'
      - METAMASK_BUILD_TYPE: 'flask'
    after_run:
      - ios_e2e_test
  run_tag_flask_tests_android:
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: elite-xl
    envs:
      - TEST_SUITE_FOLDER: './e2e/specs/flask/*'
      - TEST_SUITE_TAG: '.*Flask.*'
      - METAMASK_BUILD_TYPE: 'flask'
    after_run:
      - android_e2e_test
  android_e2e_build:
    before_run:
      - code_setup
      - set_commit_hash
    after_run:
      - notify_failure
    steps:
      - script@1:
          title: Generating ccache key using native folder checksum
          inputs:
            - content: |-
                #!/usr/bin/env bash
                ./scripts/cache/set-cache-envs.sh android
      - restore-gradle-cache@2: {}
      - install-missing-android-tools@3:
          inputs:
            - ndk_version: $NDK_VERSION
            - gradlew_path: $PROJECT_LOCATION/gradlew
      - file-downloader@1:
          inputs:
            - source: $BITRISEIO_ANDROID_QA_KEYSTORE_URL
            - destination: android/keystores/internalRelease.keystore
      - script@1:
          title: Install CCache & symlink
          inputs:
            - content: |-
                #!/usr/bin/env bash
                sudo apt update
                sudo apt install ccache -y
      - restore-cache@2:
          title: Restore CCache
          inputs:
            - key: '{{ getenv "CCACHE_KEY" }}'
      - script@1:
          title: Set skip ccache upload
          run_if: '{{ enveq "BITRISE_CACHE_HIT" "exact" }}'
          inputs:
            - content: |-
                #!/usr/bin/env bash
                envman add --key SKIP_CCACHE_UPLOAD --value "true"
      - script@1:
          title: Run detox build
          timeout: 1200
          is_always_run: true
          inputs:
            - content: |-
                #!/usr/bin/env bash
                ./scripts/cache/setup-ccache.sh
                if [ "$TEST_SUITE" = "Regression" ]; then
                  TEST_SUITE="Regression"
                else
                  TEST_SUITE="Smoke"
                fi
                node -v
                export METAMASK_ENVIRONMENT='local'
                export METAMASK_BUILD_TYPE='main'
                IGNORE_BOXLOGS_DEVELOPMENT="true" yarn test:e2e:android:build:qa-release
      - save-gradle-cache@1: {}
      - save-cache@1:
          title: Save CCache
          run_if: '{{not (enveq "SKIP_CCACHE_UPLOAD" "true")}}'
          inputs:
            - key: '{{ getenv "CCACHE_KEY" }}'
            - paths: |-
                ccache
      - deploy-to-bitrise-io@2.2.3:
          inputs:
            - pipeline_intermediate_files: android/app/build/outputs:INTERMEDIATE_ANDROID_BUILD_DIR
          title: Save Android build
      - save-cache@1:
          title: Save node_modules
          inputs:
            - key: node_modules-{{ .OS }}-{{ .Arch }}-{{ getenv "BRANCH_COMMIT_HASH" }}
            - paths: node_modules
  android_e2e_test:
    before_run:
      - setup
      - prep_environment
    after_run:
      - notify_failure
    steps:
      - restore-gradle-cache@2: {}
      - pull-intermediate-files@1:
          inputs:
            - artifact_sources: .*
          title: Pull Android build
      - script@1:
          title: Copy Android build for Detox
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -ex

                # Create directories for Detox
                mkdir -p "$BITRISE_SOURCE_DIR/android/app/build/outputs"

                # Copy saved files for Detox usage
                # INTERMEDIATE_ANDROID_BUILD_DIR is the cached directory from android_e2e_build's "Save Android build" step
                cp -r "$INTERMEDIATE_ANDROID_BUILD_DIR" "$BITRISE_SOURCE_DIR/android/app/build"
      - restore-cache@2:
          title: Restore cache node_modules
          inputs:
            - key: node_modules-{{ .OS }}-{{ .Arch }}-{{ getenv "BRANCH_COMMIT_HASH" }}
      - avd-manager@1:
          inputs:
            - api_level: '34'
            - abi: 'x86_64'
            - create_command_flags: --sdcard 8192M
            - start_command_flags: -read-only
            - profile: pixel_5
      - wait-for-android-emulator@1: {}
      - script@1:
          title: Run detox test
          timeout: 1200
          is_always_run: false
          inputs:
            - content: |-
                #!/usr/bin/env bash
                if [ -n "$TEST_SUITE_FOLDER" ]; then
                  echo "TEST_SUITE_FOLDER value is: $TEST_SUITE_FOLDER"
                fi
                if [ "$TEST_SUITE" = "Regression" ]; then
                TEST_SUITE="Regression"
                else
                TEST_SUITE="Smoke"
                fi
                if [ -n "$TEST_SUITE_TAG" ]; then
                echo "TEST_SUITE_TAG value is: $TEST_SUITE_TAG"
                TEST_SUITE=$TEST_SUITE_TAG
                fi
                export METAMASK_ENVIRONMENT='local'
                export METAMASK_BUILD_TYPE='main'
                IGNORE_BOXLOGS_DEVELOPMENT="true" yarn test:e2e:android:run:qa-release "$TEST_SUITE_FOLDER" --testNamePattern="$TEST_SUITE"
      - custom-test-results-export@1:
          title: Export test results
          is_always_run: true
          is_skippable: true
          inputs:
            - base_path: $BITRISE_SOURCE_DIR/e2e/reports/
            - test_name: E2E Tests
            - search_pattern: $BITRISE_SOURCE_DIR/e2e/reports/junit.xml
      - deploy-to-bitrise-io@2.2.3:
          title: Deploy test report files
          is_always_run: true
          is_skippable: true
      - script@1:
          title: Copy screenshot files
          is_always_run: true
          run_if: .IsBuildFailed
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -ex
                cp -r "$BITRISE_SOURCE_DIR/artifacts"  "$BITRISE_DEPLOY_DIR"
      - deploy-to-bitrise-io@2.3:
          title: Deploy test screenshots
          is_always_run: true
          run_if: .IsBuildFailed
          inputs:
            - deploy_path: $BITRISE_DEPLOY_DIR
            - is_compress: true
            - zip_name: E2E_Android_Failure_Artifacts
    meta:
      bitrise.io:
        machine_type_id: elite-xl
        stack: linux-docker-android-22.04
  ios_api_specs:
    before_run:
      - setup
      - install_applesimutils
      - prep_environment
    after_run:
      - notify_failure
    steps:
      - pull-intermediate-files@1:
          inputs:
            - artifact_sources: .*
          title: Pull iOS build
      - script@1:
          title: Copy iOS build for Detox
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -ex

                # Create directories for Detox
                mkdir -p "$BITRISE_SOURCE_DIR/ios/build/Build"
                mkdir -p "$BITRISE_SOURCE_DIR/../Library/Detox/ios"

                # Copy saved files for Detox usage
                # INTERMEDIATE_IOS_BUILD_DIR & INTERMEDIATE_IOS_DETOX_DIR are the cached directories by ios_e2e_build's "Save iOS build" step
                cp -r "$INTERMEDIATE_IOS_BUILD_DIR" "$BITRISE_SOURCE_DIR/ios/build"
                cp -r "$INTERMEDIATE_IOS_DETOX_DIR" "$BITRISE_SOURCE_DIR/../Library/Detox"
      - restore-cocoapods-cache@2: {}
      - restore-cache@2:
          title: Restore cache node_modules
          inputs:
            - key: node_modules-{{ .OS }}-{{ .Arch }}-{{ getenv "BRANCH_COMMIT_HASH" }}
      - certificate-and-profile-installer@1: {}
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: $VERSION_NAME
            - plist_path: $PROJECT_LOCATION_IOS/MetaMask/Info.plist
      - script:
          inputs:
            - content: |-
                # Add cache directory to environment variable
                envman add --key BREW_APPLESIMUTILS --value "$(brew --cellar)/applesimutils"
                envman add --key BREW_OPT_APPLESIMUTILS --value "/usr/local/opt/applesimutils"
                brew tap wix/brew
          title: Set Env Path for caching deps
      - script@1:
          title: Run detox test
          timeout: 1200
          is_always_run: false
          inputs:
            - content: |-
                #!/usr/bin/env bash
                yarn test:api-specs --retries 1
      - script@1:
          is_always_run: true
          is_skippable: false
          title: Add tests reports to Bitrise
          inputs:
            - content: |-
                #!/usr/bin/env bash
                cp -r $BITRISE_SOURCE_DIR/html-report/index.html $BITRISE_HTML_REPORT_DIR/
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: true
          is_skippable: false
          inputs:
            - deploy_path: $BITRISE_HTML_REPORT_DIR
          title: Deploy test report files
  ios_e2e_build:
    envs:
      - NO_FLIPPER: '1'
    before_run:
      - install_applesimutils
      - code_setup
      - set_commit_hash
    after_run:
      - notify_failure
    steps:
      - script@1:
          title: Generating ccache key using native folder checksum
          inputs:
            - content: |-
                #!/usr/bin/env bash
                ./scripts/cache/set-cache-envs.sh ios
      - certificate-and-profile-installer@1: {}
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: $VERSION_NAME
            - plist_path: $PROJECT_LOCATION_IOS/MetaMask/Info.plist
      - script:
          inputs:
            - content: |-
                # Add cache directory to environment variable
                envman add --key BREW_APPLESIMUTILS --value "$(brew --cellar)/applesimutils"
                envman add --key BREW_OPT_APPLESIMUTILS --value "/usr/local/opt/applesimutils"
                brew tap wix/brew
          title: Set Env Path for caching deps
      - script@1:
          title: Install CCache & symlink
          inputs:
            - content: |-
                #!/usr/bin/env bash
                brew install ccache with HOMEBREW_NO_DEPENDENTS_CHECK=1
                ln -s $(which ccache) /usr/local/bin/gcc
                ln -s $(which ccache) /usr/local/bin/g++
                ln -s $(which ccache) /usr/local/bin/cc
                ln -s $(which ccache) /usr/local/bin/c++
                ln -s $(which ccache) /usr/local/bin/clang
                ln -s $(which ccache) /usr/local/bin/clang++
      - restore-cache@2:
          title: Restore CCache
          inputs:
            - key: '{{ getenv "CCACHE_KEY" }}'
      - script@1:
          title: Set skip ccache upload
          run_if: '{{ enveq "BITRISE_CACHE_HIT" "exact" }}'
          inputs:
            - content: |-
                #!/usr/bin/env bash
                envman add --key SKIP_CCACHE_UPLOAD --value "true"
      - script@1:
          title: Run detox build
          timeout: 1200
          is_always_run: true
          inputs:
            - content: |-
                #!/usr/bin/env bash
                ./scripts/cache/setup-ccache.sh
                node -v
                export METAMASK_ENVIRONMENT='local'
                export METAMASK_BUILD_TYPE=${METAMASK_BUILD_TYPE:-'flask'}
                IGNORE_BOXLOGS_DEVELOPMENT="true" yarn test:e2e:ios:build:qa-release
      - save-cocoapods-cache@1: {}
      - save-cache@1:
          title: Save CCache
          run_if: '{{not (enveq "SKIP_CCACHE_UPLOAD" "true")}}'
          inputs:
            - key: '{{ getenv "CCACHE_KEY" }}'
            - paths: |-
                ccache
      - deploy-to-bitrise-io@2.2.3:
          inputs:
            - pipeline_intermediate_files: |-
                ios/build/Build:INTERMEDIATE_IOS_BUILD_DIR
                ../Library/Detox/ios:INTERMEDIATE_IOS_DETOX_DIR
          title: Save iOS build
      - save-cache@1:
          title: Save node_modules
          inputs:
            - key: node_modules-{{ .OS }}-{{ .Arch }}-{{ getenv "BRANCH_COMMIT_HASH" }}
            - paths: node_modules
  ios_e2e_test:
    envs:
      - NO_FLIPPER: '1'
    before_run:
      - setup
      - install_applesimutils
      - prep_environment
    after_run:
      - notify_failure
    steps:
      - pull-intermediate-files@1:
          inputs:
            - artifact_sources: .*
          title: Pull iOS build
      - script@1:
          title: Copy iOS build for Detox
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -ex

                # Create directories for Detox
                mkdir -p "$BITRISE_SOURCE_DIR/ios/build/Build"
                mkdir -p "$BITRISE_SOURCE_DIR/../Library/Detox/ios"

                # Copy saved files for Detox usage
                # INTERMEDIATE_IOS_BUILD_DIR & INTERMEDIATE_IOS_DETOX_DIR are the cached directories by ios_e2e_build's "Save iOS build" step
                cp -r "$INTERMEDIATE_IOS_BUILD_DIR" "$BITRISE_SOURCE_DIR/ios/build"
                cp -r "$INTERMEDIATE_IOS_DETOX_DIR" "$BITRISE_SOURCE_DIR/../Library/Detox"
      - restore-cocoapods-cache@2: {}
      - restore-cache@2:
          title: Restore cache node_modules
          inputs:
            - key: node_modules-{{ .OS }}-{{ .Arch }}-{{ getenv "BRANCH_COMMIT_HASH" }}
      - certificate-and-profile-installer@1: {}
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: $VERSION_NAME
            - plist_path: $PROJECT_LOCATION_IOS/MetaMask/MetaMask-QA-Info.plist
      - script:
          inputs:
            - content: |-
                # Add cache directory to environment variable
                envman add --key BREW_APPLESIMUTILS --value "$(brew --cellar)/applesimutils"
                envman add --key BREW_OPT_APPLESIMUTILS --value "/usr/local/opt/applesimutils"
                brew tap wix/brew
          title: Set Env Path for caching deps
      - script@1:
          title: Run detox test
          timeout: 1200
          is_always_run: false
          inputs:
            - content: |-
                #!/usr/bin/env bash
                if [ -n "$TEST_SUITE_FOLDER" ]; then
                  echo "TEST_SUITE_FOLDER value is: $TEST_SUITE_FOLDER"
                fi
                if [ "$TEST_SUITE" = "Regression" ]; then
                  TEST_SUITE="Regression"
                else
                  TEST_SUITE="Smoke"
                fi
                if [ -n "$TEST_SUITE_TAG" ]; then
                echo "TEST_SUITE_TAG value is: $TEST_SUITE_TAG"
                TEST_SUITE=$TEST_SUITE_TAG
                fi
                node -v
                export METAMASK_ENVIRONMENT='local'
                export METAMASK_BUILD_TYPE=${METAMASK_BUILD_TYPE:-'main'}
                IGNORE_BOXLOGS_DEVELOPMENT="true" yarn test:e2e:ios:run:qa-release "$TEST_SUITE_FOLDER" --testNamePattern="$TEST_SUITE"
      - custom-test-results-export@1:
          is_always_run: true
          is_skippable: false
          title: Export test results
          inputs:
            - base_path: $BITRISE_SOURCE_DIR/e2e/reports/
            - test_name: E2E Tests
            - search_pattern: $BITRISE_SOURCE_DIR/e2e/reports/junit.xml
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: true
          is_skippable: true
          title: Deploy test report files
      - script@1:
          is_always_run: true
          run_if: .IsBuildFailed
          title: Copy screenshot files
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -ex
                cp -r "$BITRISE_SOURCE_DIR/artifacts"  "$BITRISE_DEPLOY_DIR"
      - deploy-to-bitrise-io@2.3:
          is_always_run: true
          run_if: .IsBuildFailed
          title: Deploy test screenshots
          inputs:
            - deploy_path: $BITRISE_DEPLOY_DIR
            - is_compress: true
            - zip_name: 'E2E_IOS_Failure_Artifacts'
  start_e2e_tests:
    steps:
      - build-router-start@0:
          inputs:
            - workflows: |-
                ios_e2e_test
                wdio_android_e2e_test
            - wait_for_builds: 'true'
            - access_token: $BITRISE_START_BUILD_ACCESS_TOKEN
      - build-router-wait@0:
          inputs:
            - abort_on_fail: 'yes'
            - access_token: $BITRISE_START_BUILD_ACCESS_TOKEN
  build_android_release:
    before_run:
      - code_setup
    after_run:
      - notify_failure
    steps:
      - change-android-versioncode-and-versionname@1:
          inputs:
            - new_version_name: $VERSION_NAME
            - new_version_code: $VERSION_NUMBER
            - build_gradle_path: $PROJECT_LOCATION_ANDROID/app/build.gradle
      - file-downloader@1:
          inputs:
            - source: $BITRISEIO_ANDROID_KEYSTORE_URL
            - destination: android/keystores/release.keystore
      - restore-gradle-cache@2: {}
      - install-missing-android-tools@3:
          inputs:
            - ndk_version: $NDK_VERSION
            - gradlew_path: $PROJECT_LOCATION/gradlew
      - script@1:
          inputs:
            - content: |-
                #!/usr/bin/env bash
                node -v
                METAMASK_BUILD_TYPE='main' METAMASK_ENVIRONMENT='production' yarn build:android:pre-release:bundle
          title: Build Android Pre-Release Bundle
          is_always_run: false
      - save-gradle-cache@1: {}
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - pipeline_intermediate_files: $PROJECT_LOCATION/app/build/outputs/apk/prod/release/app-prod-release.apk:BITRISE_PLAY_STORE_APK_PATH
            - deploy_path: $PROJECT_LOCATION/app/build/outputs/apk/prod/release/app-prod-release.apk
          title: Bitrise Deploy APK
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - pipeline_intermediate_files: $PROJECT_LOCATION/app/build/outputs/apk/prod/release/sha512sums.txt:BITRISE_PLAY_STORE_SHA512SUMS_PATH
            - deploy_path: $PROJECT_LOCATION/app/build/outputs/apk/prod/release/sha512sums.txt
          title: Bitrise Deploy Checksum
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - pipeline_intermediate_files: $PROJECT_LOCATION/app/build/outputs/mapping/prodRelease/mapping.txt:BITRISE_PLAY_STORE_MAPPING_PATH
            - deploy_path: $PROJECT_LOCATION/app/build/outputs/mapping/prodRelease/mapping.txt
          title: Bitrise ProGuard Map Files
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - pipeline_intermediate_files: $PROJECT_LOCATION/app/build/outputs/bundle/prodRelease/app-prod-release.aab:BITRISE_PLAY_STORE_ABB_PATH
            - deploy_path: $PROJECT_LOCATION/app/build/outputs/bundle/prodRelease/app-prod-release.aab
          title: Bitrise Deploy AAB
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - pipeline_intermediate_files: sourcemaps/android/index.js.map:BITRISE_PLAY_STORE_SOURCEMAP_PATH
            - deploy_path: sourcemaps/android/index.js.map
          title: Bitrise Deploy Sourcemaps
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: elite-xl
  build_android_release_and_upload_sourcemaps:
    envs:
      - SENTRY_DISABLE_AUTO_UPLOAD: 'false'
    after_run:
      - build_android_release
  build_android_devbuild:
    before_run:
      - code_setup
    after_run:
      - notify_failure
    steps:
      - change-android-versioncode-and-versionname@1:
          inputs:
            - new_version_name: $VERSION_NAME
            - new_version_code: $VERSION_NUMBER
            - build_gradle_path: $PROJECT_LOCATION_ANDROID/app/build.gradle
      - restore-gradle-cache@2: {}
      - install-missing-android-tools@3:
          inputs:
            - ndk_version: $NDK_VERSION
            - gradlew_path: $PROJECT_LOCATION/gradlew
      - script@1:
          inputs:
            - content: |-
                #!/usr/bin/env bash
                node -v
                GIT_BRANCH=$BITRISE_GIT_BRANCH METAMASK_BUILD_TYPE='main' METAMASK_ENVIRONMENT='debug' yarn build:android:devbuild
          title: Build Android Dev Build
          is_always_run: false
      - save-gradle-cache@1: {}
      - script:
          title: Copy and Rename APK
          inputs:
            - content: |-
                # Define the source path of the generated APK
                SOURCE_APK_PATH="$PROJECT_LOCATION/app/build/outputs/apk/prod/debug/app-prod-debug.apk"

                # Define the destination path with the new name
                DEST_APK_PATH="$BITRISE_DEPLOY_DIR/android-expo-dev-build.apk"

                # Copy and rename the APK
                cp "$SOURCE_APK_PATH" "$DEST_APK_PATH"

                # Optionally, print the new path for verification
                echo "APK has been copied and renamed to: $DEST_APK_PATH"
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - deploy_path: '$BITRISE_DEPLOY_DIR/android-expo-dev-build.apk'
          title: Bitrise Deploy APK
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: elite-xl
  build_android_qa:
    before_run:
      - code_setup
    after_run:
      - _upload_apk_to_browserstack
      - notify_failure
    steps:
      - change-android-versioncode-and-versionname@1:
          inputs:
            - new_version_name: $VERSION_NAME
            - new_version_code: $VERSION_NUMBER
            - build_gradle_path: $PROJECT_LOCATION_ANDROID/app/build.gradle
      - file-downloader@1:
          inputs:
            - source: $BITRISEIO_ANDROID_QA_KEYSTORE_URL
            - destination: android/keystores/internalRelease.keystore
      - restore-gradle-cache@2: {}
      - install-missing-android-tools@3:
          inputs:
            - ndk_version: $NDK_VERSION
            - gradlew_path: $PROJECT_LOCATION/gradlew

      - script@1:
          inputs:
            - content: |-
                #!/usr/bin/env bash
                node -v
                GIT_BRANCH=$BITRISE_GIT_BRANCH METAMASK_BUILD_TYPE='main' METAMASK_ENVIRONMENT='qa' yarn build:android:pre-release:bundle:qa
          title: Build Android Pre-Release Bundle
          is_always_run: false
      - save-gradle-cache@1: {}
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - deploy_path: $PROJECT_LOCATION/app/build/outputs/apk/qa/release/$QA_APK_NAME.apk
          title: Bitrise Deploy APK
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - deploy_path: $PROJECT_LOCATION/app/build/outputs/apk/qa/release/sha512sums.txt
          title: Bitrise Deploy Checksum
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - deploy_path: $PROJECT_LOCATION/app/build/outputs/mapping/qaRelease/mapping.txt
          title: Bitrise ProGuard Map Files
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - deploy_path: $PROJECT_LOCATION/app/build/outputs/bundle/qaRelease/app-qa-release.aab
          title: Bitrise Deploy AAB
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - deploy_path: sourcemaps/android/index.js.map
          title: Bitrise Deploy Sourcemaps
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: elite-xl
  _upload_apk_to_browserstack:
    steps:
      - script@1:
          title: Upload APK to Browserstack
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -e
                set -x
                set -o pipefail
                APK_PATH=$PROJECT_LOCATION/app/build/outputs/apk/qa/release/app-qa-release.apk
                CUSTOM_ID="$BITRISE_GIT_BRANCH-$VERSION_NAME-$VERSION_NUMBER"
                CUSTOM_ID=${CUSTOM_ID////-}
                curl -u "$BROWSERSTACK_USERNAME:$BROWSERSTACK_ACCESS_KEY" -X POST "https://api-cloud.browserstack.com/app-automate/upload" -F "file=@$APK_PATH" -F 'data={"custom_id": "'$CUSTOM_ID'"}' | jq -j '.app_url' | envman add --key BROWSERSTACK_ANDROID_APP_URL
                APK_PATH_FOR_APP_LIVE=$PROJECT_LOCATION/app/build/outputs/apk/qa/release/"$CUSTOM_ID".apk
                mv "$APK_PATH" "$APK_PATH_FOR_APP_LIVE"
                curl -u "$BROWSERSTACK_USERNAME:$BROWSERSTACK_ACCESS_KEY" -X POST "https://api-cloud.browserstack.com/app-live/upload" -F "file=@$APK_PATH_FOR_APP_LIVE" -F 'data={"custom_id": "'$CUSTOM_ID'"}'
                curl -u "$BROWSERSTACK_USERNAME:$BROWSERSTACK_ACCESS_KEY" -X GET https://api-cloud.browserstack.com/app-automate/recent_apps | jq > browserstack_uploaded_apps.json
      - share-pipeline-variable@1:
          title: Persist BROWSERSTACK_ANDROID_APP_URL across all stages
          inputs:
            - variables: |-
                BROWSERSTACK_ANDROID_APP_URL
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - pipeline_intermediate_files: $BITRISE_SOURCE_DIR/browserstack_uploaded_apps.json:BROWSERSTACK_UPLOADED_APPS_LIST
          title: Save Browserstack uploaded apps JSON
  wdio_android_e2e_test:
    before_run:
      - code_setup
    after_run:
      - notify_failure
    steps:
      - script@1:
          title: Run Android E2E tests on Browserstack
          is_always_run: true
          inputs:
            - content: |-
                #!/usr/bin/env bash

                # Check if TEST_TYPE is set to upgrade
                if [ "$TEST_TYPE" = "upgrade" ]; then
                  TEST_TYPE="--upgrade"

                # Check if TEST_TYPE is set to performance
                elif [ "$TEST_TYPE" = "performance" ]; then
                  TEST_TYPE="--performance"
                fi
                yarn test:wdio:android:browserstack $TEST_TYPE
      - script@1:
          is_always_run: true
          is_skippable: false
          title: Package test reports
          inputs:
            - content: |-
                #!/usr/bin/env bash
                cd $BITRISE_SOURCE_DIR/wdio/reports/
                zip -r test-report.zip html/
                mv test-report.zip $BITRISE_DEPLOY_DIR/
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: true
          is_skippable: false
          inputs:
            - deploy_path: $BITRISE_DEPLOY_DIR/test-report.zip
          title: Deploy test report
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: standard
  wdio_ios_e2e_test:
    before_run:
      - code_setup
    after_run:
      - notify_failure
    steps:
      - script@1:
          title: Run iOS E2E tests on Browserstack
          is_always_run: true
          inputs:
            - content: |-
                #!/usr/bin/env bash
                # Check if TEST_TYPE is set to upgrade
                if [ "$TEST_TYPE" = "upgrade" ]; then
                  TEST_TYPE="--upgrade"
                # Check if TEST_TYPE is set to performance
                elif [ "$TEST_TYPE" = "performance" ]; then
                  TEST_TYPE="--performance"
                fi
                yarn test:wdio:ios:browserstack $TEST_TYPE
      - script@1:
          is_always_run: true
          is_skippable: false
          title: Package test reports
          inputs:
            - content: |-
                #!/usr/bin/env bash
                cd $BITRISE_SOURCE_DIR/wdio/reports/
                zip -r test-report.zip html/
                mv test-report.zip $BITRISE_DEPLOY_DIR/
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: true
          is_skippable: false
          inputs:
            - deploy_path: $BITRISE_DEPLOY_DIR/test-report.zip
          title: Deploy test report
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: standard
  deploy_android_to_store:
    steps:
      - pull-intermediate-files@1:
          inputs:
            - artifact_sources: .*
      - google-play-deploy:
          inputs:
            - app_path: $BITRISE_PLAY_STORE_ABB_PATH
            - track: internal
            - service_account_json_key_path: $BITRISEIO_BITRISEIO_SERVICE_ACCOUNT_JSON_KEY_URL_URL
            - package_name: $MM_ANDROID_PACKAGE_NAME
    envs:
      - opts:
          is_expand: true
        MM_ANDROID_PACKAGE_NAME: io.metamask
  deploy_ios_to_store:
    steps:
      - pull-intermediate-files@1:
          inputs:
            - artifact_sources: .*
      - deploy-to-itunesconnect-application-loader@1:
          inputs:
            - ipa_path: $BITRISE_APP_STORE_IPA_PATH
  build_ios_release:
    envs:
      - NO_FLIPPER: '1'
    before_run:
      - code_setup
    after_run:
      - notify_failure
    steps:
      - certificate-and-profile-installer@1: {}
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: $VERSION_NAME
            - build_version: $VERSION_NUMBER
            - plist_path: $PROJECT_LOCATION_IOS/MetaMask/Info.plist
      - script@1:
          inputs:
            - content: |-
                #!/usr/bin/env bash
                METAMASK_BUILD_TYPE='main' METAMASK_ENVIRONMENT='production' yarn build:ios:pre-release
          title: iOS Sourcemaps & Build
          is_always_run: false
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - pipeline_intermediate_files: ios/build/output/MetaMask.ipa:BITRISE_APP_STORE_IPA_PATH
            - deploy_path: ios/build/output/MetaMask.ipa
          title: Deploy iOS IPA
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - deploy_path: ios/build/MetaMask.xcarchive
          title: Deploy Symbols File
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - pipeline_intermediate_files: sourcemaps/ios/index.js.map:BITRISE_APP_STORE_SOURCEMAP_PATH
            - deploy_path: sourcemaps/ios/index.js.map
          title: Deploy Source Map
  build_ios_release_and_upload_sourcemaps:
    envs:
      - SENTRY_DISABLE_AUTO_UPLOAD: 'false'
    after_run:
      - build_ios_release
  build_ios_devbuild:
    before_run:
      - code_setup
    after_run:
      - notify_failure
    steps:
      - certificate-and-profile-installer@1: {}
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: $VERSION_NAME
            - build_version: $VERSION_NUMBER
            - plist_path: $PROJECT_LOCATION_IOS/MetaMask/Info.plist
      - script@1:
          inputs:
            - content: |-
                #!/usr/bin/env bash
                node -v
                GIT_BRANCH=$BITRISE_GIT_BRANCH METAMASK_BUILD_TYPE='main' METAMASK_ENVIRONMENT='debug' yarn build:ios:devbuild
          title: iOS Sourcemaps & Build
          is_always_run: false
      - script:
          title: Copy and Rename IPA
          inputs:
            - content: |-
                # Define the source path of the generated IPA
                SOURCE_IPA_PATH="ios/build/output/MetaMask.ipa"

                # Define the destination path with the new name
                DEST_IPA_PATH="$BITRISE_DEPLOY_DIR/ios-expo-dev-build.ipa"

                # Copy and rename the IPA
                cp "$SOURCE_IPA_PATH" "$DEST_IPA_PATH"

                # Optionally, print the new path for verification
                echo "IPA has been copied and renamed to: $DEST_IPA_PATH"
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - pipeline_intermediate_files: ios/build/output/MetaMask.ipa:BITRISE_APP_STORE_IPA_PATH
            - deploy_path: '$BITRISE_DEPLOY_DIR/ios-expo-dev-build.ipa'
          title: Deploy iOS IPA
  build_ios_qa:
    envs:
      - NO_FLIPPER: '1'
    before_run:
      - code_setup
    after_run:
      - _upload_ipa_to_browserstack
      - notify_failure
    steps:
      - certificate-and-profile-installer@1: {}
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: $VERSION_NAME
            - build_version: $VERSION_NUMBER
            - plist_path: $PROJECT_LOCATION_IOS/MetaMask/MetaMask-QA-Info.plist
      - script@1:
          inputs:
            - content: |-
                #!/usr/bin/env bash
                node -v
                GIT_BRANCH=$BITRISE_GIT_BRANCH METAMASK_BUILD_TYPE='main' METAMASK_ENVIRONMENT='qa' yarn build:ios:pre-qa
          title: iOS Sourcemaps & Build
          is_always_run: false
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - pipeline_intermediate_files: ios/build/output/MetaMask-QA.ipa:BITRISE_APP_STORE_IPA_PATH
            - deploy_path: ios/build/output/MetaMask-QA.ipa
          title: Deploy iOS IPA
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - deploy_path: ios/build/MetaMask-QA.xcarchive
          title: Deploy Symbols File
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - pipeline_intermediate_files: sourcemaps/ios/index.js.map:BITRISE_APP_STORE_SOURCEMAP_PATH
            - deploy_path: sourcemaps/ios/index.js.map
          title: Deploy Source Map
  _upload_ipa_to_browserstack:
    steps:
      - script@1:
          title: Upload IPA to Browserstack
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -e
                set -x
                set -o pipefail
                CUSTOM_ID="$BITRISE_GIT_BRANCH-$VERSION_NAME-$VERSION_NUMBER"
                CUSTOM_ID=${CUSTOM_ID////-}
                IPA_PATH=ios/build/output/MetaMask-QA.ipa
                IPA_PATH_FOR_APP_LIVE=ios/build/output/"$CUSTOM_ID".ipa
                curl -u "$BROWSERSTACK_USERNAME:$BROWSERSTACK_ACCESS_KEY" -X POST "https://api-cloud.browserstack.com/app-automate/upload" -F "file=@$IPA_PATH" -F 'data={"custom_id": "'$CUSTOM_ID'"}' | jq -j '.app_url' | envman add --key BROWSERSTACK_IOS_APP_URL
                mv "$IPA_PATH" "$IPA_PATH_FOR_APP_LIVE"
                curl -u "$BROWSERSTACK_USERNAME:$BROWSERSTACK_ACCESS_KEY" -X POST "https://api-cloud.browserstack.com/app-live/upload" -F "file=@$IPA_PATH_FOR_APP_LIVE" -F 'data={"custom_id": "'$CUSTOM_ID'"}'
                curl -u "$BROWSERSTACK_USERNAME:$BROWSERSTACK_ACCESS_KEY" -X GET https://api-cloud.browserstack.com/app-automate/recent_apps | jq > browserstack_uploaded_apps.json
      - share-pipeline-variable@1:
          title: Persist BROWSERSTACK_IOS_APP_URL across all stages
          inputs:
            - variables: |-
                BROWSERSTACK_IOS_APP_URL
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - deploy_path: browserstack_uploaded_apps.json
          title: Bitrise Deploy Browserstack Uploaded Apps
  build_ios_flask_release:
    before_run:
      - code_setup
    after_run:
      - notify_failure
    steps:
      - certificate-and-profile-installer@1: {}
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: $FLASK_VERSION_NAME
            - build_version: $FLASK_VERSION_NUMBER
            - plist_path: $PROJECT_LOCATION_IOS/MetaMask/MetaMask-Flask-Info.plist
      - script@1:
          inputs:
            - content: |-
                #!/usr/bin/env bash
                node -v
                METAMASK_BUILD_TYPE='flask' METAMASK_ENVIRONMENT='production' yarn build:ios:pre-flask
          title: iOS Sourcemaps & Build
          is_always_run: false
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - pipeline_intermediate_files: ios/build/output/MetaMask-Flask.ipa:BITRISE_APP_STORE_IPA_PATH
            - deploy_path: ios/build/output/MetaMask-Flask.ipa
          title: Deploy iOS IPA
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - deploy_path: ios/build/MetaMask-Flask.xcarchive:BITRISE_APP_STORE_XCARCHIVE_PATH
          title: Deploy Symbols File
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - pipeline_intermediate_files: sourcemaps/ios/index.js.map:BITRISE_APP_STORE_SOURCEMAP_PATH
            - deploy_path: sourcemaps/ios/index.js.map
          title: Deploy Source Map
  build_android_flask_release:
    before_run:
      - code_setup
    after_run:
      - notify_failure
    steps:
      - change-android-versioncode-and-versionname@1:
          inputs:
            - new_version_name: $FLASK_VERSION_NAME
            - new_version_code: $FLASK_VERSION_NUMBER
            - build_gradle_path: $PROJECT_LOCATION_ANDROID/app/build.gradle
      - file-downloader@1:
          inputs:
            - source: $BITRISEIO_ANDROID_FLASK_KEYSTORE_URL_URL
            - destination: android/keystores/flaskRelease.keystore
      - restore-gradle-cache@2: {}
      - install-missing-android-tools@3:
          inputs:
            - ndk_revision: $NDK_VERSION
            - gradlew_path: $PROJECT_LOCATION/gradlew

      - script@1:
          inputs:
            - content: |-
                #!/usr/bin/env bash
                node -v
                METAMASK_BUILD_TYPE='flask' METAMASK_ENVIRONMENT='production' yarn build:android:pre-release:bundle:flask
          title: Build Android Pre-Release Bundle
          is_always_run: false
      - save-gradle-cache@1: {}
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - pipeline_intermediate_files: $PROJECT_LOCATION/app/build/outputs/apk/flask/release/app-flask-release.apk:BITRISE_PLAY_STORE_APK_PATH
            - deploy_path: $PROJECT_LOCATION/app/build/outputs/apk/flask/release/app-flask-release.apk
          title: Bitrise Deploy APK
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - pipeline_intermediate_files: $PROJECT_LOCATION/app/build/outputs/apk/flask/release/sha512sums.txt:BITRISE_PLAY_STORE_SHA512SUMS_PATH
            - deploy_path: $PROJECT_LOCATION/app/build/outputs/apk/flask/release/sha512sums.txt
          title: Bitrise Deploy Checksum
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - pipeline_intermediate_files: $PROJECT_LOCATION/app/build/outputs/mapping/flaskRelease/mapping.txt:BITRISE_PLAY_STORE_MAPPING_PATH
            - deploy_path: $PROJECT_LOCATION/app/build/outputs/mapping/flaskRelease/mapping.txt
          title: Bitrise ProGuard Map Files
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - pipeline_intermediate_files: $PROJECT_LOCATION/app/build/outputs/bundle/flaskRelease/app-flask-release.aab:BITRISE_PLAY_STORE_ABB_PATH
            - deploy_path: $PROJECT_LOCATION/app/build/outputs/bundle/flaskRelease/app-flask-release.aab
          title: Bitrise Deploy AAB
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: false
          is_skippable: true
          inputs:
            - pipeline_intermediate_files: /bitrise/src/sourcemaps/android/index.js.map:BITRISE_PLAY_STORE_SOURCEMAP_PATH
            - deploy_path: sourcemaps/android/index.js.map
          title: Bitrise Deploy Sourcemaps
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: elite-xl
  ios_e2e_build_flask:
    envs:
      - NO_FLIPPER: '1'
      - METAMASK_BUILD_TYPE: 'flask'
    before_run:
      - install_applesimutils
      - code_setup
      - set_commit_hash
    after_run:
      - notify_failure
    steps:
      - script@1:
          title: Generating ccache key using native folder checksum
          inputs:
            - content: |-
                #!/usr/bin/env bash
                ./scripts/cache/set-cache-envs.sh ios
      - certificate-and-profile-installer@1: {}
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: $VERSION_NAME
            - plist_path: $PROJECT_LOCATION_IOS/MetaMask/Info.plist
      - script:
          inputs:
            - content: |-
                # Add cache directory to environment variable
                envman add --key BREW_APPLESIMUTILS --value "$(brew --cellar)/applesimutils"
                envman add --key BREW_OPT_APPLESIMUTILS --value "/usr/local/opt/applesimutils"
                brew tap wix/brew
          title: Set Env Path for caching deps
      - script@1:
          title: Install CCache & symlink
          inputs:
            - content: |-
                #!/usr/bin/env bash
                brew install ccache with HOMEBREW_NO_DEPENDENTS_CHECK=1
                ln -s $(which ccache) /usr/local/bin/gcc
                ln -s $(which ccache) /usr/local/bin/g++
                ln -s $(which ccache) /usr/local/bin/cc
                ln -s $(which ccache) /usr/local/bin/c++
                ln -s $(which ccache) /usr/local/bin/clang
                ln -s $(which ccache) /usr/local/bin/clang++
      - restore-cache@2:
          title: Restore CCache
          inputs:
            - key: '{{ getenv "CCACHE_KEY" }}'
      - script@1:
          title: Set skip ccache upload
          run_if: '{{ enveq "BITRISE_CACHE_HIT" "exact" }}'
          inputs:
            - content: |-
                #!/usr/bin/env bash
                envman add --key SKIP_CCACHE_UPLOAD --value "true"
      - script@1:
          title: Run detox build
          timeout: 1200
          is_always_run: true
          inputs:
            - content: |-
                #!/usr/bin/env bash
                ./scripts/cache/setup-ccache.sh
                node -v
                export METAMASK_ENVIRONMENT='local'
                export METAMASK_BUILD_TYPE='flask'
                IGNORE_BOXLOGS_DEVELOPMENT="true" yarn test:e2e:ios:build:qa-release
      - save-cocoapods-cache@1: {}
      - save-cache@1:
          title: Save CCache
          run_if: '{{not (enveq "SKIP_CCACHE_UPLOAD" "true")}}'
          inputs:
            - key: '{{ getenv "CCACHE_KEY" }}'
            - paths: |-
                ccache
      - deploy-to-bitrise-io@2.2.3:
          inputs:
            - pipeline_intermediate_files: |-
                ios/build/Build:INTERMEDIATE_IOS_BUILD_DIR
                ../Library/Detox/ios:INTERMEDIATE_IOS_DETOX_DIR
          title: Save iOS build
      - save-cache@1:
          title: Save node_modules
          inputs:
            - key: node_modules-{{ .OS }}-{{ .Arch }}-{{ getenv "BRANCH_COMMIT_HASH" }}
            - paths: node_modules
  ios_e2e_test_flask:
    envs:
      - NO_FLIPPER: '1'
      - METAMASK_BUILD_TYPE: 'flask'
    before_run:
      - setup
      - install_applesimutils
      - prep_environment
    after_run:
      - notify_failure
    steps:
      - pull-intermediate-files@1:
          inputs:
            - artifact_sources: .*
          title: Pull iOS build
      - script@1:
          title: Copy iOS build for Detox
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -ex

                # Create directories for Detox
                mkdir -p "$BITRISE_SOURCE_DIR/ios/build/Build"
                mkdir -p "$BITRISE_SOURCE_DIR/../Library/Detox/ios"

                # Copy saved files for Detox usage
                # INTERMEDIATE_IOS_BUILD_DIR & INTERMEDIATE_IOS_DETOX_DIR are the cached directories by ios_e2e_build's "Save iOS build" step
                cp -r "$INTERMEDIATE_IOS_BUILD_DIR" "$BITRISE_SOURCE_DIR/ios/build"
                cp -r "$INTERMEDIATE_IOS_DETOX_DIR" "$BITRISE_SOURCE_DIR/../Library/Detox"
      - restore-cocoapods-cache@2: {}
      - restore-cache@2:
          title: Restore cache node_modules
          inputs:
            - key: node_modules-{{ .OS }}-{{ .Arch }}-{{ getenv "BRANCH_COMMIT_HASH" }}
      - certificate-and-profile-installer@1: {}
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: $VERSION_NAME
            - plist_path: $PROJECT_LOCATION_IOS/MetaMask/Info.plist
      - script:
          inputs:
            - content: |-
                # Add cache directory to environment variable
                envman add --key BREW_APPLESIMUTILS --value "$(brew --cellar)/applesimutils"
                envman add --key BREW_OPT_APPLESIMUTILS --value "/usr/local/opt/applesimutils"
                brew tap wix/brew
          title: Set Env Path for caching deps
      - script@1:
          title: Start Metro bundler
          inputs:
            - content: |-
                #!/usr/bin/env bash
                # Start Metro bundler in the background
                export PATH="$PATH:$BITRISE_SOURCE_DIR/node_modules/.bin"
                yarn start --reset-cache &
                # Save the PID to kill it later
                echo $! > metro.pid
                # Wait for Metro to start
                sleep 30
      - script@1:
          title: Run detox test
          timeout: 1200
          is_always_run: false
          inputs:
            - content: |-
                #!/usr/bin/env bash
                if [ -n "$TEST_SUITE_FOLDER" ]; then
                  echo "TEST_SUITE_FOLDER value is: $TEST_SUITE_FOLDER"
                else
                  # Default to Flask specs folder if not specified
                  TEST_SUITE_FOLDER="e2e/specs/flask/"
                fi
                if [ "$TEST_SUITE" = "Regression" ]; then
                  TEST_SUITE="Regression"
                else
                  TEST_SUITE="Smoke"
                fi
                if [ -n "$TEST_SUITE_TAG" ]; then
                  echo "TEST_SUITE_TAG value is: $TEST_SUITE_TAG"
                  TEST_SUITE=$TEST_SUITE_TAG
                fi
                export PATH="$PATH:$BITRISE_SOURCE_DIR/node_modules/.bin"
                export METAMASK_ENVIRONMENT='local'
                export METAMASK_BUILD_TYPE='flask'
                IS_TEST='true' METAMASK_BUILD_TYPE='flask' detox test -c ios.sim.debug "$TEST_SUITE_FOLDER" --testNamePattern="$TEST_SUITE"
      - script@1:
          title: Kill Metro bundler
          is_always_run: true
          inputs:
            - content: |-
                #!/usr/bin/env bash
                if [ -f metro.pid ]; then
                  kill $(cat metro.pid) || true
                  rm metro.pid
                fi
      - custom-test-results-export@1:
          is_always_run: true
          is_skippable: false
          title: Export test results
          inputs:
            - base_path: $BITRISE_SOURCE_DIR/e2e/reports/
            - test_name: E2E Tests
            - search_pattern: $BITRISE_SOURCE_DIR/e2e/reports/junit.xml
      - deploy-to-bitrise-io@2.2.3:
          is_always_run: true
          is_skippable: true
          title: Deploy test report files
      - script@1:
          is_always_run: true
          run_if: .IsBuildFailed
          title: Copy screenshot files
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -ex
                cp -r "$BITRISE_SOURCE_DIR/artifacts"  "$BITRISE_DEPLOY_DIR"
      - deploy-to-bitrise-io@2.3:
          is_always_run: true
          run_if: .IsBuildFailed
          title: Deploy test screenshots
          inputs:
            - deploy_path: $BITRISE_DEPLOY_DIR
            - is_compress: true
            - zip_name: 'E2E_IOS_Failure_Artifacts'
  android_e2e_build_flask:
    before_run:
      - code_setup
      - set_commit_hash
    after_run:
      - notify_failure
    steps:
      - script@1:
          title: Generating ccache key using native folder checksum
          inputs:
            - content: |-
                #!/usr/bin/env bash
                ./scripts/cache/set-cache-envs.sh android
      - restore-gradle-cache@2: {}
      - install-missing-android-tools@3:
          inputs:
            - ndk_version: $NDK_VERSION
            - gradlew_path: $PROJECT_LOCATION/gradlew
      - file-downloader@1:
          inputs:
            - source: $BITRISEIO_ANDROID_QA_KEYSTORE_URL
            - destination: android/keystores/internalRelease.keystore
      - script@1:
          title: Install CCache & symlink
          inputs:
            - content: |-
                #!/usr/bin/env bash
                sudo apt update
                sudo apt install ccache -y
      - restore-cache@2:
          title: Restore CCache
          inputs:
            - key: '{{ getenv "CCACHE_KEY" }}'
      - script@1:
          title: Set skip ccache upload
          run_if: '{{ enveq "BITRISE_CACHE_HIT" "exact" }}'
          inputs:
            - content: |-
                #!/usr/bin/env bash
                envman add --key SKIP_CCACHE_UPLOAD --value "true"
      - script@1:
          title: Run detox build
          timeout: 1200
          is_always_run: true
          inputs:
            - content: |-
                #!/usr/bin/env bash
                ./scripts/cache/setup-ccache.sh
                node -v
                export METAMASK_ENVIRONMENT='local'
                export METAMASK_BUILD_TYPE='flask'
                IGNORE_BOXLOGS_DEVELOPMENT="true" yarn test:e2e:android:build:qa-release
      - save-gradle-cache@1: {}
      - save-cache@1:
          title: Save CCache
          run_if: '{{not (enveq "SKIP_CCACHE_UPLOAD" "true")}}'
          inputs:
            - key: '{{ getenv "CCACHE_KEY" }}'
            - paths: |-
                ccache
      - deploy-to-bitrise-io@2.2.3:
          inputs:
            - pipeline_intermediate_files: android/app/build/outputs:INTERMEDIATE_ANDROID_BUILD_DIR
          title: Save Android build
      - save-cache@1:
          title: Save node_modules
          inputs:
            - key: node_modules-{{ .OS }}-{{ .Arch }}-{{ getenv "BRANCH_COMMIT_HASH" }}
            - paths: node_modules
    meta:
      bitrise.io:
        stack: linux-docker-android-22.04
        machine_type_id: elite-xl
  android_e2e_test_flask:
    before_run:
      - setup
      - prep_environment
    after_run:
      - notify_failure
    steps:
      - restore-gradle-cache@2: {}
      - pull-intermediate-files@1:
          inputs:
            - artifact_sources: .*
          title: Pull Android build
      - script@1:
          title: Copy Android build for Detox
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -ex

                # Create directories for Detox
                mkdir -p "$BITRISE_SOURCE_DIR/android/app/build/outputs"

                # Copy saved files for Detox usage
                # INTERMEDIATE_ANDROID_BUILD_DIR is the cached directory from android_e2e_build's "Save Android build" step
                cp -r "$INTERMEDIATE_ANDROID_BUILD_DIR" "$BITRISE_SOURCE_DIR/android/app/build"
      - restore-cache@2:
          title: Restore cache node_modules
          inputs:
            - key: node_modules-{{ .OS }}-{{ .Arch }}-{{ getenv "BRANCH_COMMIT_HASH" }}
      - avd-manager@1:
          inputs:
            - api_level: '34'
            - abi: 'x86_64'
            - create_command_flags: --sdcard 8192M
            - start_command_flags: -read-only
            - profile: pixel_5
      - wait-for-android-emulator@1: {}
      - script@1:
          title: Run detox test
          timeout: 1200
          is_always_run: false
          inputs:
            - content: |-
                #!/usr/bin/env bash
                if [ -n "$TEST_SUITE_FOLDER" ]; then
                  echo "TEST_SUITE_FOLDER value is: $TEST_SUITE_FOLDER"
                else
                  # Default to Flask specs folder if not specified
                  TEST_SUITE_FOLDER="e2e/specs/flask/"
                fi
                if [ "$TEST_SUITE" = "Regression" ]; then
                TEST_SUITE="Regression"
                else
                TEST_SUITE="Smoke"
                fi
                if [ -n "$TEST_SUITE_TAG" ]; then
                echo "TEST_SUITE_TAG value is: $TEST_SUITE_TAG"
                TEST_SUITE=$TEST_SUITE_TAG
                fi
                export METAMASK_ENVIRONMENT='local'
                export METAMASK_BUILD_TYPE='flask'
                IGNORE_BOXLOGS_DEVELOPMENT="true" yarn test:e2e:android:run:qa-release e2e/specs/flask/
      - custom-test-results-export@1:
          title: Export test results
          is_always_run: true
          is_skippable: true
          inputs:
            - base_path: $BITRISE_SOURCE_DIR/e2e/reports/
            - test_name: E2E Tests
            - search_pattern: $BITRISE_SOURCE_DIR/e2e/reports/junit.xml
      - deploy-to-bitrise-io@2.2.3:
          title: Deploy test report files
          is_always_run: true
          is_skippable: true
      - script@1:
          title: Copy screenshot files
          is_always_run: true
          run_if: .IsBuildFailed
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -ex
                cp -r "$BITRISE_SOURCE_DIR/artifacts"  "$BITRISE_DEPLOY_DIR"
      - deploy-to-bitrise-io@2.3:
          title: Deploy test screenshots
          is_always_run: true
          run_if: .IsBuildFailed
          inputs:
            - deploy_path: $BITRISE_DEPLOY_DIR
            - is_compress: true
            - zip_name: E2E_Android_Failure_Artifacts
    meta:
      bitrise.io:
        machine_type_id: elite-xl
        stack: linux-docker-android-22.04

app:
  envs:
    - opts:
        is_expand: false
      MM_NOTIFICATIONS_UI_ENABLED: false
    - opts:
        is_expand: false
      MM_NETWORK_UI_REDESIGN_ENABLED: false
    - opts:
        is_expand: false
      PORTFOLIO_VIEW: true
    - opts:
        is_expand: false
      MM_MULTICHAIN_V1_ENABLED: true
    - opts:
        is_expand: false
      MM_CHAIN_PERMISSIONS: true
    - opts:
        is_expand: false
      MM_PERMISSIONS_SETTINGS_V1_ENABLED: false
    - opts:
        is_expand: false
      MM_SECURITY_ALERTS_API_ENABLED: true
    - opts:
        is_expand: false
      MM_STABLECOIN_LENDING_UI_ENABLED: false
    - opts:
        is_expand: false
      PROJECT_LOCATION: android
    - opts:
        is_expand: false
      NDK_VERSION: 24.0.8215888
    - opts:
        is_expand: false
      QA_APK_NAME: app-qa-release
    - opts:
        is_expand: false
      MODULE: app
    - opts:
        is_expand: false
      VARIANT: ''
    - opts:
        is_expand: false
      BITRISE_PROJECT_PATH: ios/MetaMask.xcworkspace
    - opts:
        is_expand: false
      BITRISE_SCHEME: MetaMask
    - opts:
        is_expand: false
      BITRISE_EXPORT_METHOD: enterprise
    - opts:
        is_expand: false
      PROJECT_LOCATION_ANDROID: android
    - opts:
        is_expand: false
      PROJECT_LOCATION_IOS: ios
    - opts:
        is_expand: false
      VERSION_NAME: 7.41.0
    - opts:
        is_expand: false
      VERSION_NUMBER: 1586
    - opts:
        is_expand: false
      FLASK_VERSION_NAME: 7.41.0
    - opts:
        is_expand: false
      FLASK_VERSION_NUMBER: 1586
    - opts:
        is_expand: false
      ANDROID_APK_LINK: ''
    - opts:
        is_expand: false
      ANDROID_AAP_LINK: ''
    - opts:
        is_expand: false
      IOS_APP_LINK: ''
    - opts:
        is_expand: false
      NVM_VERSION: 0.39.7
    - opts:
        is_expand: false
      NVM_SHA256SUM: '8e45fa547f428e9196a5613efad3bfa4d4608b74ca870f930090598f5af5f643'
    - opts:
        is_expand: false
      NODE_VERSION: 20.18.0
    - opts:
        is_expand: false
      YARN_VERSION: 1.22.22
    - opts:
        is_expand: false
      COREPACK_VERSION: 0.28.0
meta:
  bitrise.io:
    stack: osx-xcode-15.0.x
    machine_type_id: g2.mac.large
trigger_map:
  - push_branch: release/*
    pipeline: pr_regression_e2e_pipeline
  - push_branch: main
    pipeline: app_launch_times_and_expo_pipeline
  - tag: 'qa-*'
    pipeline: create_qa_builds_pipeline
  - tag: 'dev-e2e-*'
    pipeline: pr_smoke_e2e_pipeline
  - tag: 'v*.*.*-RC-*'
    pipeline: release_e2e_pipeline
  - push_branch: detox/address-regression-tests-slowdown
    pipeline: multichain_permissions_e2e_pipeline
